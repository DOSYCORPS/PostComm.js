// PostComm.js
// https://github.com/dwighthouse/PostComm.js
// 
// Under MIT License
// Copyright (c) 2013 Dwight House
// 
// Colossians 3:23-24

// Compressed with Uglify2
// http://lisperator.net/uglifyjs/

!function(n){"use strict"
function e(n,e,r){var t,o=n.length
for(t=0;o>t;t+=1)if(n[t][e]===r)return t
return-1}function r(n,e,r){n.hasOwnProperty(e)||(n[e]=r)}function t(n){return/^https?:\/\//.test(n)}function o(n){return n&&n.window&&n===n.window}function i(){}function u(){return n.opener||n.parent}function s(){var e=(n.document||{}).referrer
return e!==d?h.convertUrlToOrigin(e):d}function c(n){return w[n]}function a(n,r){var t,o=c(n)
return o===d?d:(t=e(o,"source",r),-1!==t?o[t]:d)}function f(n){var e=a(n.origin,n.source)
return e===d?(h.errorMessage("Unknown Comm"),d):(e.details.messageHandler(n.data,e.comm),d)}function m(n,e){var t=e.origin,o={source:e.source,comm:n,details:e}
r(w,t,[]),w[t].push(o)}function g(n){var r,t=n.origin,o=c(t)
return o===d?(h.errorMessage("Internal Error: Function unregisterComm called on Comm with unknown origin"),d):(r=e(o,"source",n.source),-1===r?(h.errorMessage("Internal Error: Function unregisterComm called on Comm with unknown source"),d):(o.splice(r,1),0===o.length&&delete w[t],d))}var d,l,v,C=n.PostComm,w={},h={}
l=function(){return n.addEventListener?function(n,e,r){n.addEventListener(e,r,!1)}:n.attachEvent?function(n,e,r){n.attachEvent("on"+e,r)}:function(n,e,r){n["on"+e]=r}}(),v=function(){return n.removeEventListener?function(n,e,r){n.removeEventListener(e,r,!1)}:n.detachEvent?function(n,e,r){n.detachEvent("on"+e,r)}:function(n,e){n["on"+e]=d}}(),h.convertUrlToOrigin=function(n){var e=n.indexOf("//")+2,r=n.indexOf("/",e)
return-1!==r?n.substr(0,r):n},h.findComm=function(n,e){var r=a(n,e)
return r!==d?r.comm:d},h.engage=function(){l(n,"message",f)},h.disengage=function(){v(n,"message",f)},h.createComm=function(n,e,r){function u(n){c.source.postMessage(n,c.origin)}function s(){g(c),c=d,a.getOrigin=i,a.getContentWindow=i,a.getMessageHandler=function(){return i},a.isValid=function(){return!1},a.destroy=i,a.sendMessage=i}var c={},a={},f=h.findComm(n,e)
return f!==d?f:(c.origin=n,c.source=e,c.messageHandler=r,c.isValid=t(n)&&o(e),a.getOrigin=function(){return c.origin},a.getContentWindow=function(){return c.source},a.getMessageHandler=function(){return c.messageHandler},a.isValid=function(){return c.isValid},a.sendMessage=i,a.destroy=i,c.isValid&&(a.sendMessage=u,a.destroy=s,m(a,c)),a)},h.createIframeComm=function(n,e){var r=h.convertUrlToOrigin(n.src)
return h.createComm(r,n.contentWindow,e)},h.createParentComm=function(n){return h.createComm(s(),u(),n)},h.noConflict=function(){return n.PostComm=C,h},h.errorMessage=function(e){return n.console&&n.console.log&&n.console.log(e)},n.postMessage&&(n.PostComm=h,"function"==typeof n.define&&n.define.amd&&n.define("postComm",[],function(){return h}))}(this)
